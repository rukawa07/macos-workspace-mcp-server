# Implementation Plan

## Task 1: ドメインモデルの実装

- [x] 1.1 (P) プリセット配置の列挙型を定義する
  - 14種類のプリセット（2分割4種、4分割4種、3分割5種、フルスクリーン1種）を列挙型として定義
  - Codable、CaseIterable、Sendableプロトコルに準拠させる
  - rawValueとして文字列を使用し、MCPパラメーターとの変換を容易にする
  - _Requirements: 1.2, 1.3, 1.4, 1.5_

- [x] 1.2 (P) 配置結果モデルを定義する
  - 配置後のウィンドウ情報、適用されたプリセット、配置先ディスプレイ名を含む構造体を作成
  - 既存のWindowInfoモデルを活用してウィンドウ情報を表現
  - JSONエンコード可能にしてMCPレスポンスとして返却できるようにする
  - _Requirements: 5.4_

## Task 2: エラー型の拡張

- [x] 2.1 (P) ウィンドウ配置固有のエラーケースを追加する
  - ウィンドウ未発見エラー（bundleIdとオプションのtitleを含む）を追加
  - ウィンドウ最小化エラー（操作不可状態）を追加
  - 配置失敗エラー（AX操作失敗時の理由を含む）を追加
  - ディスプレイ未発見エラー（指定されたディスプレイ名を含む）を追加
  - 各エラーケースに対応するユーザー向けメッセージを実装
  - _Requirements: 3.3, 4.3, 5.1, 5.2, 5.3_

## Task 3: 座標計算ロジックの実装

- [x] 3.1 プリセットに基づく配置座標を計算する機能を実装する
  - ディスプレイの作業領域（visibleFrame）を入力として受け取る
  - 2分割プリセット（左/右/上/下半分）の座標計算を実装
  - 4分割プリセット（四隅）の座標計算を実装
  - 3分割プリセット（1/3と2/3の5パターン）の座標計算を実装
  - フルスクリーンプリセット（作業領域全体）の座標計算を実装
  - 計算結果が常にvisibleFrame内に収まることを保証
  - _Requirements: 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3_

## Task 4: ウィンドウサービスの拡張

- [x] 4.1 ウィンドウ配置メソッドをサービスプロトコルに追加する
  - bundleId、オプションのtitle、プリセット、オプションのdisplayNameを引数とするメソッドシグネチャを定義
  - 配置結果を返却し、エラー時はWorkspaceErrorをスローする仕様を定義
  - _Requirements: 1.1, 3.1, 4.1, 4.2_

- [x] 4.2 対象ウィンドウを検索・特定する機能を実装する
  - bundleIdで対象アプリケーションのウィンドウを絞り込む
  - titleが指定された場合は追加でフィルタリングする
  - 複数ウィンドウが一致した場合は最前面（リストの先頭）を選択
  - 一致するウィンドウがない場合はwindowNotFoundエラーをスロー
  - 対象ウィンドウが最小化されている場合はwindowMinimizedエラーをスロー
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.2_

- [x] 4.3 配置先ディスプレイを決定する機能を実装する
  - displayNameが指定された場合は該当ディスプレイを検索
  - 指定がない場合はウィンドウの現在位置からディスプレイを特定
  - ディスプレイが見つからない場合はdisplayNotFoundエラーをスロー
  - ディスプレイのvisibleFrameを取得して座標計算に使用
  - _Requirements: 2.3, 3.1, 3.2, 3.3_

- [x] 4.4 Accessibility APIを使用してウィンドウの位置・サイズを変更する機能を実装する
  - 操作前にAccessibility権限を確認し、権限がなければpermissionDeniedエラーをスロー
  - AXUIElementを使用して対象ウィンドウへの参照を取得
  - サイズ→位置→サイズの順序で設定（ディスプレイ間移動対応）
  - AXValueCreate/AXUIElementSetAttributeValueを使用して位置・サイズを設定
  - 操作失敗時はpositioningFailedエラーをスロー
  - 操作成功時は更新後のウィンドウ情報を取得して配置結果を返却
  - _Requirements: 1.1, 5.1, 5.3, 5.4_

## Task 5: MCPツールの実装

- [x] 5.1 ウィンドウ配置ツールを作成する
  - MCPToolプロトコルに準拠したツール構造体を作成
  - ツール名「position_window」と入力スキーマを定義
  - bundleId（必須）、preset（必須）、title（オプション）、displayName（オプション）のパラメーターを受け付ける
  - パラメーターのバリデーション（必須チェック、プリセット値の妥当性）を実装
  - WindowServiceのpositionWindowメソッドを呼び出して配置を実行
  - 成功時は配置結果をJSON形式でレスポンス
  - エラー時はWorkspaceErrorのuserMessageを含むエラーレスポンスを返却
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 5.2 ツールレジストリに新規ツールを登録する
  - 登録済みツール一覧にPositionWindowToolを追加
  - handleCallToolのswitchケースに新規ツールのルーティングを追加
  - WindowServiceインスタンスを適切に注入
  - _Requirements: 1.1_

## Task 6: テストの実装

- [x] 6.1 (P) プリセット列挙型のテストを作成する
  - 全14ケースの存在確認
  - rawValueからの初期化テスト
  - CaseIterableによる全ケース列挙テスト
  - _Requirements: 1.2, 1.3, 1.4, 1.5_

- [x] 6.2 (P) 座標計算ロジックのテストを作成する
  - 各プリセットに対する計算結果の検証
  - 異なるvisibleFrameサイズでの動作確認
  - 計算結果がvisibleFrame内に収まることの検証
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 6.3 (P) エラーケースのuserMessageテストを作成する
  - 新規追加した各エラーケースのメッセージ生成確認
  - bundleId、title、displayName等のパラメーターが正しく埋め込まれることの検証
  - _Requirements: 3.3, 4.3, 5.1, 5.2, 5.3_

- [x] 6.4 MCPツールのテストを作成する
  - パラメーターバリデーションのテスト（必須パラメーター欠落、不正なプリセット値）
  - モックサービスを使用した正常系レスポンスの検証
  - エラーレスポンスの形式検証
  - _Requirements: 1.1, 5.4_
