# Implementation Plan

## Tasks

- [x] 1. 基盤となるデータモデルとエラー型を実装する
- [x] 1.1 (P) アプリケーション情報を表現するデータモデルを作成する
    - アプリケーションのbundle ID、名前、プロセスID、非表示状態を保持できる構造を定義
    - Sendableプロトコルに準拠させてSwift 6のconcurrency対応
    - _Requirements: 3.2_

- [x] 1.2 (P) 操作結果を表現するデータモデルを作成する
    - 起動結果としてプロセスID、アプリ名、既存起動フラグを保持する構造を定義
    - 終了結果としてアプリ名を保持する構造を定義
    - _Requirements: 1.4, 2.3_

- [x] 1.3 (P) エラー型を定義して一貫したエラーハンドリングを可能にする
    - アプリ未発見、未起動、起動失敗、権限不足、パラメーター不正のケースを網羅
    - 各エラーケースに対してユーザーフレンドリーなエラーメッセージを生成
    - 権限エラーには具体的な設定手順（システム設定 > プライバシーとセキュリティ > アクセシビリティ）を含める
    - _Requirements: 4.2, 4.3, 5.1, 5.2, 5.3, 5.4_

- [x] 2. アプリケーション制御サービスを実装する
- [x] 2.1 サービスのプロトコルを定義する
    - 起動、終了、一覧取得、権限確認の4つの機能を抽象化
    - テスト可能性のためにプロトコルベースで設計
    - 非同期操作としてasync/awaitパターンを使用
    - _Requirements: 1.1, 2.1, 3.1, 4.1_

- [x] 2.2 NSWorkspaceを使用したアプリケーション起動機能を実装する
    - bundle IDを指定してアプリケーションを起動できるようにする
    - 既に起動中のアプリは最前面にアクティブ化する
    - 起動成功時にプロセスIDとアプリ名を返す
    - bundle IDが見つからない場合はエラーをスローする
    - _Requirements: 1.1, 1.3, 1.4, 1.5_

- [x] 2.3 NSRunningApplicationを使用したアプリケーション終了機能を実装する
    - bundle IDを指定してアプリケーションを終了できるようにする
    - 通常の終了処理（terminate）を使用し、強制終了は行わない
    - 終了成功時にアプリ名を返す
    - アプリが起動していない場合はエラーをスローする
    - _Requirements: 2.1, 2.3, 2.4, 2.5_

- [x] 2.4 起動中アプリケーション一覧取得機能を実装する
    - NSWorkspaceから現在起動中のアプリケーション一覧を取得する
    - 各アプリのbundle ID、名前、プロセスID、非表示状態を返す
    - UIを持つアプリケーションのみをフィルタリングし、システムプロセスを除外する
    - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 2.5 Accessibility APIの権限確認機能を実装する
    - AXIsProcessTrustedを使用して権限状態を確認する
    - 権限がない場合に適切なエラーを返せるようにする
    - _Requirements: 4.1, 4.2_

- [x] 3. MCPツールの共通基盤を実装する
- [x] 3.1 ツール共通プロトコルを定義する
    - ツール名、ツール定義、実行メソッドを標準化
    - 新規ツール追加時の一貫性を確保
    - _Requirements: 6.4, 6.5_

- [x] 3.2 ツール登録とルーティング機能を実装する
    - 登録済みツール一覧を管理
    - ListToolsハンドラーでツール定義を返却
    - CallToolハンドラーでツール名に応じたルーティング
    - 未知のツール名に対してエラーレスポンスを返す
    - _Requirements: 6.1, 6.2, 6.3_

- [x] 4. 各MCPツールを実装する
- [x] 4.1 (P) アプリケーション起動ツールを実装する
    - launch_applicationツールの定義（名前、説明、入力スキーマ）を作成
    - bundleIdパラメーターの検証ロジックを実装
    - サービス呼び出しと結果のMCPレスポンス変換
    - エラー時にisError: trueと具体的なメッセージを返す
    - _Requirements: 1.1, 1.4, 1.5, 5.1, 5.4, 6.1, 6.4, 6.5_

- [x] 4.2 (P) アプリケーション終了ツールを実装する
    - quit_applicationツールの定義（名前、説明、入力スキーマ）を作成
    - bundleIdパラメーターの検証ロジックを実装
    - サービス呼び出しと結果のMCPレスポンス変換
    - エラー時にisError: trueと具体的なメッセージを返す
    - _Requirements: 2.1, 2.3, 2.4, 5.1, 5.4, 6.2, 6.4, 6.5_

- [x] 4.3 (P) 起動中アプリケーション一覧ツールを実装する
    - list_applicationsツールの定義（名前、説明、入力スキーマ）を作成
    - パラメーターなしで呼び出し可能な設計
    - サービス呼び出しと結果のJSON形式への変換
    - _Requirements: 3.1, 3.2, 6.3, 6.4, 6.5_

- [x] 5. システム統合と既存コードの移行を行う
- [x] 5.1 Main.swiftをToolRegistryを使用するように更新する
    - 既存のToolsAPI呼び出しをToolRegistryに切り替え
    - ListToolsハンドラーとCallToolハンドラーを更新
    - サーバー初期化時のハンドラー登録を確認
    - _Requirements: 6.1, 6.2, 6.3_

- [x] 5.2 既存のToolsAPI.swiftを整理する
    - 新しいツール構造への移行が完了したことを確認
    - 不要になったコードを削除
    - _Requirements: 6.1, 6.2, 6.3_

- [x] 6. 動作確認とテストを実施する
- [x] 6.1 WorkspaceErrorのエラーメッセージ生成をテストする
    - 各エラーケースが正しいメッセージを生成することを検証
    - 出力値ベーステストとしてlocalizedDescriptionを確認
    - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 6.2 MCP Inspectorを使用した動作確認を行う
    - launch_applicationツールの起動・アクティブ化動作を確認
    - quit_applicationツールの終了動作を確認
    - list_applicationsツールの一覧取得動作を確認
    - エラーケース（存在しないbundle ID等）の動作を確認
    - _Requirements: 1.1, 1.3, 1.4, 1.5, 2.1, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4_
